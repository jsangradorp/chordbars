% package chordbars
% S. Kramm
% 2017 - 2018
% see https://github.com/skramm/chordbars

%TODO: find a way to avoid the need for escaping "sharp" character ("#") for the user
% see:
% -https://tex.stackexchange.com/questions/400981/
% -https://tex.stackexchange.com/a/38720/11083

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{chordbars}[2017/11/28 version 0.1]

\RequirePackage{tikz}
\RequirePackage{pgfmath}
\RequirePackage{tkz-euclide}

\usetikzlibrary{math,shapes}

\RequirePackage{calc}
\RequirePackage{ifthen}
%\RequirePackage{fixltx2e}

\def\vspacebefore{1ex}
\def\vspaceafter{1ex}

\newcommand{\songtitle}
{
  \begin{center}%
  	\begin{tikzpicture}[line width=1.5pt]
	\tikzstyle{block} = [rectangle, draw, text width=20em, text centered, minimum height=4em]
      	\node [block,font=\fontsize{20}{28}\selectfont\bfseries] (init) { \@title~-~\@author };
  	\end{tikzpicture}
  \end{center}%
  \par
  \vskip 1.5em
}

\newcounter{NumMesure}
\newcounter{NumPart}
\newcounter{CurrentBarInLine}
\newcounter{CurrentBar}
\newcounter{CurrentLine}

\newcommand{\bpm}[1]
{
	\xdef\tempoBPM{#1}
	\rightline{Tempo=#1 BPM}
}

% "Beats Per Bar"
% default value
\xdef\bpb{4}

\newcommand{\bpbfour}
{
	\xdef\bpb{4}
}
\newcommand{\bpbthree}
{
	\xdef\bpb{3}
}

\newcommand{\resetchordbars}
{
	\setcounter{NumMesure}{0}
	\setcounter{NumPart}{0}
	\setcounter{CurrentBarInLine}{0}
}

\newcommand{\printNbBars}
{
	\ifthenelse{\boolean{printBarNumber}}
	{
		Total number of bars: \arabic{NumMesure}, duration=\pgfmathparse{\theNumMesure/\tempoBPM*60*\bpb}\pgfmathresult {} s.
	}{}
}

\newboolean{printBarNumber}

\newcommand{\countbarsYes}
{
	\setboolean{printBarNumber}{true}  
}

\newcommand{\countbarsNo}
{
	\setboolean{printBarNumber}{false}  
}

\def\barsize{1.6}%	


\xdef\NumberOfBarsPerLine{4}

\newenvironment{AAA}[3][abc]
{
AAA \newline
arg1=#1
\newline arg2=#2
\newline arg3=#3
}
{
\newline Bye!
}
%==========================================================================
% main environment, has 2 mandatory arguments
% arg 1: total number of 4 beat bars (4, 8, ...)
% arg 2: part name (can be empty)
% optional arg: nb of repetitions (default is 1)

\newenvironment{chordbar}[3][1]
{
	\newcommand{\newchordline}
	{
		\setcounter{CurrentBarInLine}{0}
		\refstepcounter{CurrentLine}
	}

	\newcommand{\chordf}[1]%
	{ %
		\ifthenelse
			{\theCurrentBarInLine=\NumberOfBarsPerLine}
			{
				\refstepcounter{CurrentLine}
				\setcounter{CurrentBarInLine}{0}
			}
			{}
		\refstepcounter{CurrentBarInLine}%
		\pgfmathsetmacro{\x}{-\barsize/2+\theCurrentBarInLine*\barsize}
		\pgfmathsetmacro{\y}{\value{CurrentLine})*\barsize+\barsize/2}		
		\draw (\x,\y) node {##1};%
	}%

	\newcommand{\chordh}[2]%
	{
		\ifthenelse
			{\theCurrentBarInLine=\NumberOfBarsPerLine}
			{
				\refstepcounter{CurrentLine}
				\setcounter{CurrentBarInLine}{0}
			}
			{}
		\refstepcounter{CurrentBarInLine}%
		\typeout{CurrentBarInLine=\theCurrentBarInLine}
		\draw ( %
			{\barsize*(\theCurrentBarInLine-1)}, %
			{(\theCurrentLine+1)*\barsize} %
		) %
		-- %
		( %
			{\theCurrentBarInLine*\barsize}, %
			{\theCurrentLine*\barsize} %
		);		
		\draw (
			{-3*\barsize/4+\theCurrentBarInLine*\barsize},
			{\theCurrentLine*\barsize+1*\barsize/4}
		) node {##1};
		\draw (
			{-\barsize/4+\theCurrentBarInLine*\barsize},
			{\theCurrentLine*\barsize+3*\barsize/4}
		) node {##2};%	
		
	}
	
	\newcommand{\repeatBar}%
	{ %
		\def\delta{0.36}
		\pgfmathsetmacro{\Axa}{\theCurrentBarInLine*\barsize+\delta*\barsize}
		\pgfmathsetmacro{\Axb}{(\theCurrentBarInLine+1)*\barsize-\delta*\barsize}
		\pgfmathsetmacro{\Aya}{(1-\delta)*\barsize+\theCurrentLine*\barsize}
		\pgfmathsetmacro{\Ayb}{\delta*\barsize+\theCurrentLine*\barsize}

		\coordinate (A) at (\Axa,\Ayb);
		\coordinate (B) at (\Axb,\Aya);

		\fill (A) circle[radius=2pt];
		\fill (B) circle[radius=2pt];
		\draw [thick] (\Axa,\Aya) -- (\Axb,\Ayb); %
		%
		\refstepcounter{CurrentBarInLine}
		\ifnum\value{CurrentBarInLine}=#2
		{
			\refstepcounter{CurrentLine}
			\setcounter{CurrentBarInLine}{0}
		}
		\fi		
	}%

	\newcommand{\repeatBarPair}%
	{ %
		\def\delta{0.36}
		\pgfmathsetmacro{\Axa}{\theCurrentBarInLine*\barsize+\delta*\barsize}
		\pgfmathsetmacro{\Axb}{(\theCurrentBarInLine+2)*\barsize-\delta*\barsize}
		\pgfmathsetmacro{\Aya}{(1-\delta)*\barsize+\theCurrentLine*\barsize}
		\pgfmathsetmacro{\Ayb}{\delta*\barsize+\theCurrentLine*\barsize}

		\coordinate (A) at (\Axa,\Ayb);
		\coordinate (B) at (\Axb,\Aya);

		\fill (A) circle[radius=2pt];
		\fill (B) circle[radius=2pt];
		\draw [thick] (\Axa,\Aya) -- (\Axb,\Ayb); %
		%
		\refstepcounter{CurrentBarInLine}
		\ifnum\value{CurrentBarInLine}=#2
		{
			\refstepcounter{CurrentLine}
			\setcounter{CurrentBarInLine}{0}
		}
		\fi		
	}%

	
	\typeout{chordbarl: START #2}

	\fontfamily{phv}\selectfont
	\setcounter{CurrentLine}{0}
	\setcounter{CurrentBarInLine}{0}
	\setcounter{CurrentBar}{0}

	\refstepcounter{NumPart}%
	\refstepcounter{NumMesure}%
	\noindent\ignorespaces %
	\vspace{\vspacebefore}
%\resizebox{8cm}{!} {	
%	\scalebox{2}{
	\begin{tikzpicture}[line width=1pt,x=1cm,y=-1cm] %,scale=2]

	\ifthenelse
		{\boolean{printBarNumber}}	
		{\draw (-.3,.5*\barsize) node{\bf \theNumMesure};}
		{}

% compute the number of bars of the first line
	\xdef\NbBarsInitialLine{\NumberOfBarsPerLine}
	\ifthenelse
		{#2<\NumberOfBarsPerLine}
		{\xdef\NbBarsInitialLine{#1}}
		{}
			
% initial horizontal line
	\draw (0,0) -- (\NbBarsInitialLine*\barsize,0);

% draw part title	
	\draw (0,-\barsize*.2) node [anchor=west, align=left] {\bf Part \theNumPart: #3}; 

	\pgfmathtruncatemacro{\nblines}{(#2-1)/\NumberOfBarsPerLine+1}	
	\typeout{chordbarl: nblines=\nblines}
	\foreach \line in {1,...,\nblines}
	{

		\draw (0,{\barsize*(\line-1)}) -- (0,\line*\barsize); % first vertical line
		\xdef\nbbars{\NumberOfBarsPerLine}
		\ifnum\line=\nblines
		{
			\pgfmathtruncatemacro{\nbbars}{#2-\NumberOfBarsPerLine*(\nblines-1)}
			\xdef\nbbars{\nbbars}
		}
		\fi
		\typeout{chordbarl: nbbars=\nbbars}
		\foreach \k in {1,...,{\nbbars}}
		{
			\draw (\k*\barsize,{(\line-1)*\barsize}) -- (\k*\barsize,{\line*\barsize});
			\draw (0,{\line*\barsize}) -- (\k*\barsize,{\line*\barsize});
			
			\refstepcounter{CurrentBar}%
		}
	}
	\setcounter{NumMesure}{#1*#2+\value{NumMesure}-1}

% print the number of repetitions
	\ifnum#1=1 {}
	\else
	\ifthenelse
			{\boolean{printBarNumber}}
			{\draw (\NbBarsInitialLine*\barsize+1,0.5*\barsize) node {\Large \bf x~#1};}
			{} 
	\fi
}%
{
\typeout{chordbar: END}
	\end{tikzpicture}
%	} %
%	\par\noindent%
%	\ignorespacesafterend	
	\vspace{\vspaceafter}
}

%\catcode`#=12

%\newcounter{dd2}
%
%\newenvironment{chordbarh}[3]
%{
%\typeout{chordbarh: START}
%
%	\fontfamily{phv}\selectfont
%%
%	\refstepcounter{NumPart}%
%	\refstepcounter{NumMesure}%
%%	
%	\pgfmathsetmacro{\NbVLines}{#1/2}	
%	\pgfmathsetmacro{\arg}{#1}	
%	\setcounter{dd2}{#1/2}
%	\noindent\ignorespaces %
%	\vspace{\vspacebefore}
%	\begin{tikzpicture}[line width=1pt]
%	\draw (0,\barsize*1.1) node [anchor=west, align=left] {Part \theNumPart: #3}; % title
%	\draw (0,0) -- (0,\barsize);
%	\draw (0,0) -- (\value{dd2}*\barsize,0);
%	\draw (-.2,.5) node{\theNumMesure};	
%%
%% Draw vertical lines
%%	
%	\foreach \k in {1,...,\NbVLines}
%	{
%		\draw (\k*\barsize,0) -- (\k*\barsize,\barsize);
%	};
%	\ifodd\arg%
%		\draw (\value{dd2}*\barsize,0) -- ({(1+\arg)*\barsize/2},\barsize);%
%		\draw (0,\barsize) -- ({(\value{dd2}+1)*\barsize},\barsize);
%%
%		\draw ({(\NbVLines+1)*\barsize+1},0.5) node {x~#2};
%	\else %
%		\draw (0,\barsize) -- (#1*0.5*\barsize,\barsize);
%		\draw (\value{dd2}*\barsize+1,0.5) node {x~#2};
%	\fi
%%
%% Compute the bar number
%%
%	\ifodd\arg%
%		\setcounter{NumMesure}{(\value{dd2}+1)*#2+\value{NumMesure}-1}
%	\else
%		\setcounter{NumMesure}{\value{dd2}*#2+\value{NumMesure}-1}
%	\fi
%
%
%}%
%{
%	\end{tikzpicture}
%	\par\noindent%
%	\ignorespacesafterend	
%}


\AtBeginDocument{\catcode`#=12 }

\endinput
  
