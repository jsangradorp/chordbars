% package chordbars
% S. Kramm
% 2017 - 2018
% see https://github.com/skramm/chordbars

%TODO: find a way to avoid the need for escaping "sharp" character ("#") for the user
% see https://tex.stackexchange.com/questions/400981/


\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{chordbars}[2017/11/28 version 0.1]

\RequirePackage{tikz}
\RequirePackage{pgfmath}
\RequirePackage{tkz-euclide}

\usetikzlibrary{math,shapes}

\RequirePackage{calc}
\RequirePackage{ifthen}

\newcommand{\songtitle}
{
  \begin{center}%
  	\begin{tikzpicture}[line width=1.5pt]
	\tikzstyle{block} = [rectangle, draw, text width=20em, text centered, minimum height=4em]
      	\node [block,font=\fontsize{20}{28}\selectfont\bfseries] (init) { \@title~-~\@author };
  	\end{tikzpicture}
  \end{center}%
  \par
  \vskip 1.5em
}


\newcounter{NumMesure}
\newcounter{NumPart}
\newcounter{CurrentBar}
\newcounter{CurrentBarD}

\newcommand{\resetchordbars}
{
	\setcounter{NumMesure}{0}
	\setcounter{NumPart}{0}
	\setcounter{CurrentBar}{0}
}


\def\barsize{1.6}%	

\newcommand{\tempchord}{}
\newcommand{\tempchordf}{}
\newcommand{\tempchordh}{}
\newcommand{\tempchordfn}{}
\newcommand{\tempchordhn}{}

%==========================================================================
% one line of bars
% arg 1: number of 4 beat bars (4, 8, ...)
% arg 2: nb of repetitions
% arg 3: part name (can be empty)
\newenvironment{chordbar}[3]
{
	\setcounter{CurrentBar}{0}

	\newcommand{\repeatchord}%
	{ %
		\def\delta{0.32};
		\pgfmathsetmacro{\Axa}{\theCurrentBar*\barsize+\delta*\barsize};
		\pgfmathsetmacro{\Axb}{(\theCurrentBar+1)*\barsize-\delta*\barsize};
		\pgfmathsetmacro{\Aya}{(1-\delta)*\barsize};
		\pgfmathsetmacro{\Ayb}{\delta*\barsize};

		\coordinate (A) at (\Axa,\Aya);
		\coordinate (B) at (\Axb,\Ayb);

		\coordinate (C) at (\Axa,\Ayb);
		\coordinate (D) at (\Axb,\Aya);

		\draw (A) node[circle,thin,draw,radius=0.1,fill] {};
		\node at (B) [circle,fill,radius=0.1] {};
		\draw [thick] (C) -- (D); %
		\refstepcounter{CurrentBar};%
	}%

% FULL BAR CHORD
% Argument: chord name
	\ifdefined\chordf\else
	\renewcommand{\tempchordf}[1]%
	{ %
		\refstepcounter{CurrentBar}%
		\draw (-\barsize/2+\theCurrentBar*\barsize,\barsize/2) node {##1};%
	}%
	\global\let\chordf\tempchordf
	\fi


% UN-NUMBERED HALF BAR CHORD
% Argument 1: first chord (beat 1,2)
% Argument 2: second chord (beat 3,4)

	\newcommand{\chordh}[2]%
	{
		\refstepcounter{CurrentBar}%
		\draw (\barsize*\theCurrentBar-\barsize,0) -- (\theCurrentBar*\barsize,\barsize);		
		\draw (-\barsize/4+\theCurrentBar*\barsize,1*\barsize/4) node {##2};%	
		\draw (-3*\barsize/4+\theCurrentBar*\barsize,3*\barsize/4) node {##1};
		\
	}



%	\ifdefined\chordh\else
%	\renewcommand{\tempchordh}[2]%
%	{ %
%		\ifthenelse{\equal{##1}{1}}
%		{
%			\refstepcounter{CurrentBar}%
%			\draw (-3*\barsize/4+\theCurrentBar*\barsize,3*\barsize/4) node {##2};
%		}
%		{
%			\draw (-\barsize/4+\theCurrentBar*\barsize,1*\barsize/4) node {##2};%	
%			\refstepcounter{CurrentBar}%
%		}
%		\draw (\barsize*\theCurrentBar-\barsize,0) -- (\theCurrentBar*\barsize,\barsize);		
%%		\draw (-\barsize/2+\theCurrentBar*\barsize,\barsize/2) node {##1};%
%	}%
%	\global\let\chordh\tempchordh
%	\fi

	
% Draw full bar chord
%	\newcommand{\chordfn}[2]
%	{ %
%		\draw (-\barsize/2+##1*\barsize,\barsize/2) node {##2};%
%	}%

% Draw full bar chord, with the bar number.
% First argument: bar number, second: chord
  \ifdefined\chordfn\else
    \renewcommand{\tempchordfn}[2]%
    {%
	    \draw (-\barsize/2+##1*\barsize,\barsize/2) node {##2};%
	    \setcounter{CurrentBar}{##1}%
    }%
    \global\let\chordfn\tempchordfn
  \fi


% Draw half bar chord
	\ifdefined\chordhn\else
	\renewcommand{\tempchordhn}[3]%
	{ %
		\ifthenelse{\equal{##3}{1}}
		{ %
			\draw (-3*\barsize/4+##1*\barsize,3*\barsize/4) node {##2};%
		} %
		{ %
			\draw (-\barsize/4+##1*\barsize,1*\barsize/4) node {##2};%		
		} %
%		\draw [line width=1pt] (\barsize*##1-\barsize,0) -- (##1*\barsize,\barsize);
		\draw (\barsize*##1-\barsize,0) -- (##1*\barsize,\barsize);
	}%
	\global\let\chordhn\tempchordhn
	\fi

%
	\fontfamily{phv}\selectfont
%\setlength{\parindent}{0in}

	\refstepcounter{NumPart}%
	\refstepcounter{NumMesure}%
	\noindent\ignorespaces %
	\begin{tikzpicture}[line width=1pt]
	\draw (0,\barsize*1.1) node [anchor=west, align=left] {Part \theNumPart: #3}; % title
	\draw (0,0) -- (0,\barsize);
	\draw (0,0) -- (#1*\barsize,0);
	\draw (0,\barsize) -- (#1*\barsize,\barsize);
	\draw (-.2,.5) node{\theNumMesure};	
	\foreach \k in {1,...,#1}
	{
		\draw (\k*\barsize,0) -- (\k*\barsize,\barsize);
	};
	\setcounter{NumMesure}{#1*#2+\value{NumMesure}-1}
	\draw (#1*\barsize+1,0.5) node {x~#2};
}%
{
	\end{tikzpicture}
	\par\noindent%
	\ignorespacesafterend	
}


%==========================================================================
% attempt of new version with several lines (WIP)
% arg 1: total number of 4 beat bars (4, 8, ...)
% arg 2: nb of bars per line
% arg 3: nb of repetitions
% arg 4: part name (can be empty)

\newenvironment{chordbarl}[4]
{
	\fontfamily{phv}\selectfont
	\setcounter{CurrentBar}{0}
	\setcounter{CurrentBarD}{0}

%	\newcommand{\chordfn}[2]
%	{ %
%		\draw (-\barsize/2+##1*\barsize,\barsize/2) node {##2};%
%	}%
	
%
	\refstepcounter{NumPart}%
	\refstepcounter{NumMesure}%
	\noindent\ignorespaces %
	\begin{tikzpicture}[line width=1pt,y=-1cm]
	\draw (-.2,.5) node{\theNumMesure};	

% initial horizontal line
	\draw (0,0) -- (#2*\barsize,0);
	\draw (0,-.5) node [anchor=west, align=left] {Part \theNumPart: #4}; % title

	\pgfmathtruncatemacro{\nblines}{(#1-1)/#2+1}	
	\foreach \line in {1,...,\nblines}
	{
%
%		\pgfmathsetmacro{\ypos}{(1+\line)*\barsize}
		\draw (0,{\barsize*(\line-1)}) -- (0,\line*\barsize);

		\draw (0,{\line*\barsize}) -- (#2*\barsize,{\line*\barsize});
		\def\nbbars{#2};
%		\ifthenelse{\equal{#1}{\CurrentBarD}}
%		{ %
%		}
%		{
%		}		
		\foreach \k in {1,...,\nbbars}
		{
			\draw (\k*\barsize,{(\line-1)*\barsize}) -- (\k*\barsize,{\line*\barsize});
			\refstepcounter{CurrentBarD}%
		};
	}
	\setcounter{NumMesure}{#1*#2+\value{NumMesure}-1}
	\draw (#2*\barsize+1,0.5) node {x~#3};
}%
{
	\end{tikzpicture}
	\par\noindent%
	\ignorespacesafterend	
}

% FULL BAR CHORD
%	\newcommand{\my@internal@chordf}[1]
%	{ %
%		\refstepcounter{CurrentBar}%
%		\draw (-\barsize/2+\theCurrentBar*\barsize,\barsize/2) node {##1};%
%	}%



\newcounter{dd2}

\newenvironment{chordbarh}[3]
{
	\fontfamily{phv}\selectfont
%
	\refstepcounter{NumPart}%
	\refstepcounter{NumMesure}%
%	
	\pgfmathsetmacro{\NbVLines}{#1/2}	
	\pgfmathsetmacro{\arg}{#1}	
	\setcounter{dd2}{#1/2}
	\noindent\ignorespaces %
	\begin{tikzpicture}[line width=1pt]
	\draw (0,\barsize*1.1) node [anchor=west, align=left] {Part \theNumPart: #3}; % title
	\draw (0,0) -- (0,\barsize);
	\draw (0,0) -- (\value{dd2}*\barsize,0);
	\draw (-.2,.5) node{\theNumMesure};	
%
% Draw vertical lines
%	
	\foreach \k in {1,...,\NbVLines}
	{
		\draw (\k*\barsize,0) -- (\k*\barsize,\barsize);
	};
	\ifodd\arg%
		\draw (\value{dd2}*\barsize,0) -- ({(1+\arg)*\barsize/2},\barsize);%
		\draw (0,\barsize) -- ({(\value{dd2}+1)*\barsize},\barsize);
%
		\draw ({(\NbVLines+1)*\barsize+1},0.5) node {x~#2};
	\else %
		\draw (0,\barsize) -- (#1*0.5*\barsize,\barsize);
		\draw (\value{dd2}*\barsize+1,0.5) node {x~#2};
	\fi
%
% Compute the bar number
%
	\ifodd\arg%
		\setcounter{NumMesure}{(\value{dd2}+1)*#2+\value{NumMesure}-1}
	\else
		\setcounter{NumMesure}{\value{dd2}*#2+\value{NumMesure}-1}
	\fi


}%
{
	\end{tikzpicture}
	\par\noindent%
	\ignorespacesafterend	
}



\endinput
  
